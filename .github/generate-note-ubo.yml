name: Generate note.com uBO filters

on:
  push:
    paths:
      - uBlacklist.txt
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate uBO-note.txt
        shell: bash
        run: |
          set -euo pipefail

          INPUT="uBlacklist.txt"
          OUTPUT="sites/uBO-note.txt"

          mkdir -p sites

          # 1. note.com のユーザー名を抽出
          # 2. 重複排除
          # 3. アルファベット順ソート
          users=$(grep -oP '\*://note\.com/\K[^/*]+' "$INPUT" \
            | sort -u)

          # 上書き
          : > "$OUTPUT"

          for user in $users; do
            cat >> "$OUTPUT" <<EOF
note.com##.m-largeNoteWrapper__card:has(.fn.m-largeNoteWrapper__link[href*="/$user"])
note.com##.o-horizontalTimeLineNote:has(.fn.o-horizontalTimeLineNote__link[href*="/$user"])
EOF
          done

      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes"
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add sites/uBO-note.txt
          git commit -m "Auto-generate note.com uBO cosmetic filters"
          git push
